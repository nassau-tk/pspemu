
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">

<!--
	Copyright (c) 1999-2011 by Digital Mars
	All Rights Reserved Written by Walter Bright
	http://www.digitalmars.com
  -->

<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="keywords" content="D programming language" />
<meta name="description" content="D Programming Language" />
<title>Migrating to Shared - D Programming Language 2.0 - Digital Mars</title>
<link rel="stylesheet" type="text/css" href="style.css" />
<link rel="stylesheet" type="text/css" href="print.css" media="print" />
<link rel="shortcut icon" href="favicon.ico" />

<!-- enable this for automated hyphenation, see http://code.google.com/p/hyphenator/ -->
<!--
<script src="http://erdani.com/js/Hyphenator.js" type="text/javascript"></script>
<script type="text/javascript">Hyphenator.run();</script>
-->

</head>

<body class="hyphenate">
<div id="heading">
	<a href="http://www.digitalmars.com/"><img src="dmlogo.gif" width="270" height="53" style="border-style:none" alt="www.digitalmars.com" align="left"></a>
	<p align="right">D Programming Language 2.0</p>
	<br>

	<div id="headingNav">
	<ul>	<li><a href="http://www.digitalmars.com/NewsGroup.html" title="User Forums"><img src="http://www.digitalmars.com/news.png" border=0 alt="User Forums"> Forum</a></li>
	<li><a href="http://www.prowiki.org/wiki4d/wiki.cgi?DocComments/Migrating To Shared
" title="Read/write comments and feedback"><img src="wiki.png" border=0 alt="D Wiki"> Wiki</a></li>
	<li><a href="index.html" title="D Programming Language" class="dlink">&nbsp;<img src="d.png" border=0 alt="D Programming Language">&nbsp;</a></li>
	<li><a href="http://www.digitalmars.com/advancedsearch.html" title="Search Digital Mars web site"><img src="search.png" border=0 alt="Search">Search</a></li>
	<li><a href="http://www.digitalmars.com/d/download.html" title="download D"><img src="download.png" border=0 alt="Download">Downloads</a></li>
	<li><a href="http://www.digitalmars.com/" title="www.digitalmars.com"><img src="home.png" border=0 alt="digitalmars.com">Home</a></li>
	</ul>
	</div>

	<div id="lastupdate">Last update Fri Jul  8 22:24:15 2011
</div>
</div>
<!-- Generated by Ddoc from migrate-to-shared.dd -->



<div id="navigation">
  
<div class="navblock">
<form method="get" action="http://www.google.com/search">
<div id="searchbox">
<input id="q" name="q" size="10" value="Search" onFocus='if(this.value == "Search"){this.value="";}'>
<input type="hidden" id="domains" name="domains" value="www.digitalmars.com">
<input type="hidden" id="sitesearch" name="sitesearch" value="www.digitalmars.com/d/2.0">
<input type="hidden" id="sourceid" name="sourceid" value="google-search">
<input type="submit" id="submit" name="submit" value="Go">
</div>
</form>
<div id="toctop">
    <ul>	<li><a href="index.html" title="D Programming Language">D 2.0 Home</a></li>
	<li><a href="spec.html" title="D Language Specification">Language Reference</a></li>
	<li><a href="phobos/phobos.html" title="D Runtime Library">Library Reference</a></li>
	<li><a href="comparison.html" title="Language Comparisons">Comparisons</a></li>
	<li><a href="http://www.digitalmars.com/d/1.0/index.html" title="D Programming Language 1.0">D 1.0 Home</a></li>
    </ul>
</div>
</div>

  
    <div class="navblock">
	<ul>		<li><a href="overview.html" title="D language overview">Overview</a></li>

		<li><a href="windows.html" title="D implementation for 32 bit Windows systems">D for Win32</a></li>

		<li><a href="dll.html" title="Writing 32 bit Windows DLLs in D">Win32 DLLs in D</a></li>

		<li><a href="COM.html" title="Windows COM Programming">COM Programming</a></li>

		<li><a href="htomodule.html" title="converting C .h header files to D modules">C .h to D Modules</a></li>

		<li><a href="faq.html" title="Frequently Asked Questions">FAQ</a></li>

		<li><a href="const-faq.html" title="Frequently Asked Questions about const">const(FAQ)</a></li>

		<li><a href="dstyle.html" title="Recommended programming style conventions">Style Guide</a></li>

		<li><a href="wc.html" title="wc - the wordcount program">Example: wc</a></li>

		<li><a href="future.html" title="Future directions">Future</a></li>

		<li><a href="changelog.html" title="History of changes to D">D Change Log</a></li>

		<li><a href="features2.html" title="Language changes for D 2.0">2.0 Features</a></li>

		<li><a href="http://www.digitalmars.com/techtips/index.html" title="Programming tips">Tech Tips</a></li>

		<li><a href="rationale.html" title="Answers to questions about D design decisions">Rationale</a></li>

		<li><a href="warnings.html" title="Explanation of D compiler generated warning messages">Warnings</a></li>

		<li><a href="http://d.puremagic.com/issues/" title="D issue and bug tracking system">Issues &amp; Bugs</a></li>

	</ul>
    </div>

    <div class="navblock">
	<h2>Articles</h2>
	<ul>		<li><a href="d-floating-point.html" title="D Floating Point">Floating Point</a></li>

		<li><a href="migrate-to-shared.html" title="Migrating to Shared">Migrating to Shared</a></li>

		<li><a href="hijack.html" title="Function Hijacking Mitigation">Hijacking</a></li>

		<li><a href="const3.html" title="Const and Immutable">Const</a></li>

		<li><a href="memory.html" title="Memory management techniques in D">Memory Management</a></li>

		<li><a href="exception-safe.html" title="Exception safe programming techniques">Exception Safety</a></li>

		<li><a href="templates-revisited.html" title="D takes a fresh look at template design">Templates Revisited</a></li>

		<li><a href="regular-expression.html" title="Programming with regular expressions">Regular Expressions</a></li>

		<li><a href="lazy-evaluation.html" title="Lazy evaluation of function arguments">Lazy Evaluation</a></li>

		<li><a href="variadic-function-templates.html" title="Variadic arguments to templates">Variadic Templates</a></li>

		<li><a href="tuple.html" title="What tuples are and how to use them">Tuples</a></li>

		<li><a href="mixin.html" title="String mixins compile string literals into D programs">Mixins</a></li>

		<li><a href="safed.html" title="SafeD - The Safe Subset of D">SafeD</a></li>

	</ul>
    </div>

    <div class="navblock">
	<h2>Slides</h2>
	<ul>		<li><a href="human-error.pdf" title="Patterns of Human Error (pdf)">Patterns of Human Error</a></li>

	</ul>
    </div>

    <div class="navblock">
	<h2>Tools</h2>
	<ul>		<li><a href="dmd-linux.html" title="dmd - the Digital Mars D compiler">DMD D Compiler (Linux)</a></li>

		<li><a href="dmd-freebsd.html" title="dmd - the Digital Mars D compiler">DMD D Compiler (FreeBSD)</a></li>

		<li><a href="dmd-osx.html" title="dmd - the Digital Mars D compiler">DMD D Compiler (Mac OSX)</a></li>

		<li><a href="dmd-windows.html" title="dmd - the Digital Mars D compiler">DMD D Compiler (Windows)</a></li>

		<li><a href="http://bitbucket.org/goshawk/gdc/wiki/Home" title="gdc - the Gnu D compiler">GDC D Compiler</a></li>

		<li><a href="http://www.digitalmars.com/ctg/optlink.html" title="Optlink - the Digital Mars Linker">Linker</a></li>

		<li><a href="http://www.digitalmars.com/ctg/trace.html" title="DMD's builtin code profiling tool">Profiler</a></li>

		<li><a href="code_coverage.html" title="DMD's builtin code coverage analysis tool">Code Coverage</a></li>

		<li><a href="rdmd.html" title="rdmd - run D programs as if they were scripts">DMD Script Shell</a></li>

		<li><a href="windbg.html" title="windbg - debugging Windows programs">Windows Debugger</a></li>

		<li><a href="htod.html" title="htod - mechanically convert C .h header files to D">C .h to D .d</a></li>

		<li><a href="http://www.prowiki.org/wiki4d/wiki.cgi?EditorSupport" title="Editors with support for D">Editors</a></li>

		<li><a href="http://www.prowiki.org/wiki4d/wiki.cgi?ReferenceForTools" title="Even more tools for D">More Tools</a></li>

	</ul>
    </div>

    <div class="navblock">
	<h2>Forums</h2>
	<ul>		<li><a href="http://www.digitalmars.com/NewsGroup.html" title="User Forums">All Forums</a></li>

		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/index.html.html">digitalmars.D</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/announce/index.html.html">digitalmars.D.announce</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/dwt/index.html.html">digitalmars.D.dwt</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/learn/index.html.html">digitalmars.D.learn</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/bugs/index.html.html">digitalmars.D.bugs</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/debugger/index.html.html">digitalmars.D.debugger</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/ide/index.html.html">digitalmars.D.ide</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/digitalmars/D/dtl/index.html.html">digitalmars.D.dtl</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/D/gnu/index.html.html">D.gnu</a></li>
		<li><a href="http://www.digitalmars.com/d/archives/index.html.html">Old D</a></li>
	</ul>
    </div>

    <div class="navblock">
	<h2>Community</h2>
	<ul>		<li><a href="http://www.prowiki.org/wiki4d/wiki.cgi?FrontPage" title="Wiki for the D Programming Language">Wiki</a></li>

		<li><a href="http://stackoverflow.com/questions/tagged/d" title="D on stackoverflow.com">Stackoverflow</a></li>

		<li><a href="http://twitter.com/#search?q=%23d_lang" title="#d_lang on twitter.com">Twitter</a></li>

		<li><a href="http://www.digitalmars.com/d/dlinks.html" title="External D related links">Links</a></li>

		
		
	</ul>
    </div>

    <div class="navblock">
	<h2>Appendices</h2>
	<ul>		<li><a href="glossary.html" title="D acronyms and jargon explained">Glossary</a></li>

		<li><a href="ascii-table.html" title="Handy ascii chart">Ascii Table</a></li>

		<li><a href="acknowledgements.html" title="Thank-you to these people who have helped with D">Acknowledgements</a></li>

	</ul>
    </div>

    
    <div class="navblock">
	<h2>Books</h2>
	<ul>		<li><a href="http://www.amazon.com/exec/obidos/ASIN/0321635361/classicempire">D Programming Language</a>
</li>
		<li><a href="http://www.amazon.com/exec/obidos/ASIN/1590599608/classicempire">Learn to Tango with D</a>
</li>
		<li><a href="http://www.amazon.com/exec/obidos/ASIN/0596520123/classicempire">Version Control with Git</a>
</li>
	</ul>
    </div>


    
<script src="http://www.gmodules.com/ig/ifr?url=http://www.google.com/ig/modules/translatemypage.xml&up_source_language=en&w=160&h=60&title=&border=&output=js"></script>
    

    <p><center><script src="http://slashdot.org/slashdot-it.js" type="text/javascript"></script></center></p>

</div>
<div id="content">
  <h1>Migrating to Shared</h1>
  
	<p>Starting with <a href="changelog.html#new2_030">dmd version 2.030</a>,
	the default storage class
	for statics and globals will be
	<a href="glossary.html#tls">thread local storage (TLS)</a>, rather
	than the classic global data segment.
	While most D code should just compile and run successfully without
	change, there can be some issues.
	</p>

<ol>	<li><a href="#performance">Performance of TLS variables</a>.</li>
	<li><a href="#vtls">Identifying TLS variables</a>.</li>
	<li><a href="#immutable">Switch to Immutable</a>.</li>
	<li><a href="#shared">Marking as shared</a>.</li>
	<li><a href="#__gshared">Cowboying with __gshared</a>.</li>
	<li><a href="#compile-errors">Compile errors</a>.</li>
	<li><a href="#link-errors">Link errors</a>.</li>
</ol>

<h3><a name="performance">Performance of TLS variables</a></h3>

	<p>Yes, reading or writing TLS variables will be slower
	than for classic global variables. It'll be about 3
	instructions rather than one.
	But on Linux, at least, TLS will be slightly faster
	than accessing classic globals using PIC (position
	independent code) compiler code generation settings.
	So it's hard to see that this would be an unacceptable
	problem. But let's presume it is. What can we do about it?
	</p>

	<ol>	<li>Minimize use of global variables. Reducing the use
	of globals can improve the modularization and maintainability
	of the code anyway, so this is a worthy goal.</li>
	<li>Make them immutable. Immutable data doesn't have
	synchronization problems, so the compiler doesn't place it
	in TLS.</li>
	<li>Cache a reference to the global. Making a local cache
	of it, and then accessing the cached value rather than the
	original, can speed things up especially if the cached value
	gets enregistered by the compiler.</li>
	<li>Cowboy it with <b>__gshared</b>.</li>
	</ol>

<h3><a name="vtls">Identifying TLS variables</a></h3>

	<p>The first step is to find all the global variables,
	so they can be reviewed for disposition.
	</p>

	<p>Given the complexity of source code, it isn't always
	easy to identify the global variables. Since it (used to be)
	implicit, there's no way to grep for them. It's hard
	to be sure you've found them all.
	</p>

	<p>A new dmd compiler switch was added, <b>-vtls</b>.
	Compiling with it on will print a list of all the global
	variables that are now defaulting to thread local storage.
	</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">int</span> x;

<span class="d_keyword">void</span> main()
{
    <span class="d_keyword">static</span> <span class="d_keyword">int</span> y;
}
</span></pre>

<pre class="console"><span class="notranslate">dmd test <b>-vtls</b>
test.d(2): x is thread local
test.d(6): y is thread local
</span></pre>

<h3><a name="#immutable">Switch to Immutable</a></h3>

	<p>Immutable data, once initialized, never changes.
	This means that there are no synchronization issues
	with multithreading, and so no need to put immutable data
	into TLS. The compiler will put immutable data into
	classic global storage, not TLS.
	</p>

	<p>A good chunk of global data falls into this category.
	Just mark it as <b>immutable</b> and it's done.
	</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">int</span>[3] table = [6, 123, 0x87];
</span></pre>
	<p>becomes:</p>
<pre class="d_code"><span class="notranslate"><span class="d_keyword">immutable</span> <span class="d_keyword">int</span>[3] table = [6, 123, 0x87];
</span></pre>

	<p>Immutability is also nice because it opens the door
	for further compiler optimizations.
	</p>

<h3><a name="shared">Marking As Shared</a></h3>

	<p>Global data that is meant to be shared among multiple
	threads should be marked with the <b>shared</b> keyword:
	</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">shared</span> <span class="d_keyword">int</span> flag;
</span></pre>

	<p>Not only does this cause <tt><span class="notranslate">flag</span></tt> to be put into
	classic global storage, it is also typed as being shared:
	</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">int</span>* p = &amp;flags;           <span class="d_comment">// error, flags is shared
</span><span class="d_keyword">shared</span>(<span class="d_keyword">int</span>)* q = &amp;flags;   <span class="d_comment">// ok
</span></span></pre>

	<p>The <tt><span class="notranslate">shared</span></tt> type attribute is transitive (like
	<tt><span class="notranslate">const</span></tt> and <tt><span class="notranslate">immutable</span></tt>) are. This enables
	static checking and sharing correctness.
	</p>

<h3><a name="__gshared">Cowboying With __gshared</a></h3>

	<p>Sometimes, none of the above solutions will be
	acceptable:
	</p>

	<ol>	<li>interfacing with C code that uses classic globals</li>
	<li>just get it working, and go back and fix it later</li>
	<li>the app is single threaded only, so no sharing issues</li>
	<li>you need every erg of performance</li>
	<li>you want to handle all the synchronization issues
	yourself</li>
	</ol>

	<p>As D is a systems language, of course there's a way to
	do this. Use the storage class <b>__gshared</b>:
	</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">__gshared</span> <span class="d_keyword">int</span> x;

<span class="d_keyword">void</span> main()
{
    <span class="d_keyword">__gshared</span> <span class="d_keyword">int</span> y;
}
</span></pre>

	<p><b>__gshared</b> stores the variable in the classic global
	data segment.
	</p>

	<p>Naturally, <b>__gshared</b> is not allowed in safe mode.
	</p>

	<p>Using <b>__gshared</b> makes such code easily searchable
	when doing QA code reviews or when going back later to
	fix any workarounds.
	</p>

<h3><a name="#compile-errors">Compile Errors</a></h3>

	<p>The most common compiler error related to TLS will be:
	</p>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">int</span> x;
<span class="d_keyword">int</span>* p = &amp;x;
</span></pre>
<pre class="console"><span class="notranslate">test.d(2): Error: non-constant expression &amp; x
</span></pre>

	<p>While this works with classic global variables, it
	won't work with TLS variables. The reason is because
	TLS variables don't have a location in memory known to
	either the linker or the loader. It's a runtime computed
	value.</p>

	<p>The solution is to initialize such things in
	a static constructor.</p>

<h3><a name="link-errors">Link Errors</a></h3>

	<p>Sometimes you may encounter strange error messages from the linker
	about the global variables.
	These are nearly always caused by one module putting the variable
	in TLS, and another putting that same variable in classic global
	storage.
	This can happen when linking code with libraries that were built
	with earlier versions of dmd. Check that libphobos2.a was properly
	replaced with the latest.
	It can also happen when interfacing with C. C globals default
	to being classic global, although C does support TLS declarations.
	Make sure the corresponding D declarations match the C ones in
	terms of TLS or classic global.
	</p>

<pre class="ccode"><span class="notranslate">int x;
extern int y;
__thread int z;
</span></pre>

<pre class="d_code"><span class="notranslate"><span class="d_keyword">extern</span> (C)
{
    <span class="d_keyword">extern</span> <span class="d_keyword">shared</span> <span class="d_keyword">int</span> x;
    <span class="d_keyword">shared</span> <span class="d_keyword">int</span> y;
    <span class="d_keyword">extern</span> <span class="d_keyword">int</span> z;
}
</span></pre>


  
<br><br>
<br><br>
<!-- Google ad -->
<script type="text/javascript"><!--
/**/google_ad_client = "pub-5628673096434613";
/**/google_ad_width = 728;
/**/google_ad_height = 90;
/**/google_ad_format = "728x90_as";
/**/google_ad_channel ="3651639259";
/**/google_page_url = document.location;
//--></script>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

</div>




<div id="footernav">
<a href="http://www.digitalmars.com/NewsGroup.html" title="User Forums">Forums</a> |
<a href="http://www.prowiki.org/wiki4d/wiki.cgi?DocComments/Migrating To Shared
" title="Read/write comments and feedback">Comments</a> |
<a href="index.html" title="D Programming Language" class="dlink">&nbsp;D&nbsp;</a> |
<a href="http://www.digitalmars.com/advancedsearch.html" title="Search Digital Mars web site">Search</a> |
<a href="http://www.digitalmars.com/d/download.html" title="download D">Downloads</a> |
<a href="http://www.digitalmars.com/" title="www.digitalmars.com">Home</a>
</div>
<div id="copyright">

Copyright &copy; 1999-2011 by Digital Mars &reg;, All Rights Reserved
 |
Page generated by <a href="http://www.digitalmars.com/d/2.0/ddoc.html">Ddoc</a>.
</div>


<script src="http://completelyexpendable.info/editable_code.js"></script>
</body>
</html>

